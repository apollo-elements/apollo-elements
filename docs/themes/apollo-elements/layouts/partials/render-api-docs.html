{{/* render-api-docs.html - Server-side API documentation rendering from custom-elements manifest */}}

{{- $pkg := .Params.package | default "" -}}
{{- $module := .Params.module | default "" -}}

{{- if and $pkg $module -}}
  {{/* Load the manifest data for this package */}}
  {{- $manifest := index .Site.Data "custom-elements-manifests" $pkg -}}

  {{- if $manifest -}}
    {{/* Find the module in the manifest - take the one with most declarations/members */}}
    {{- $matchingModules := slice -}}
    {{- range $manifest.modules -}}
      {{- if eq .path $module -}}
        {{- $matchingModules = $matchingModules | append . -}}
      {{- end -}}
    {{- end -}}

    {{/* Select the module with the most complete info (most members) */}}
    {{- $selectedModule := index $matchingModules 0 -}}
    {{- if gt (len $matchingModules) 1 -}}
      {{- range $matchingModules -}}
        {{- $currentTotal := 0 -}}
        {{- range .declarations -}}
          {{- with .members -}}
            {{- $currentTotal = add $currentTotal (len .) -}}
          {{- end -}}
        {{- end -}}

        {{- $selectedTotal := 0 -}}
        {{- range $selectedModule.declarations -}}
          {{- with .members -}}
            {{- $selectedTotal = add $selectedTotal (len .) -}}
          {{- end -}}
        {{- end -}}

        {{- if gt $currentTotal $selectedTotal -}}
          {{- $selectedModule = . -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{/* Render the selected module */}}
    {{- with $selectedModule -}}
      {{/* Find the class that best matches the page title */}}
      {{- $pageTitle := $.Title | lower -}}
      {{- $targetClass := "" -}}

      {{/* First try exact match (case-insensitive) */}}
      {{- range .declarations -}}
        {{- if eq .kind "class" -}}
          {{- $className := .name | lower -}}
          {{- if eq $className $pageTitle -}}
            {{- $targetClass = . -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}

      {{/* If no exact match, try partial match (class name contains title) */}}
      {{- if not $targetClass -}}
        {{- range .declarations -}}
          {{- if eq .kind "class" -}}
            {{- $className := .name | lower -}}
            {{- if in $className $pageTitle -}}
              {{- $targetClass = . -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}

      {{/* If still no match, use the first class declaration */}}
      {{- if not $targetClass -}}
        {{- range .declarations -}}
          {{- if eq .kind "class" -}}
            {{- $targetClass = . -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}

      {{/* Generate ToC from target class and store in page scratch */}}
      {{- with $targetClass -}}
        {{- $.Scratch.Set "apiToc" (partial "cem/render-toc.html" .) -}}
        {{/* Render the target class */}}
        {{ partial "cem/render-class.html" . }}
      {{- end -}}

      {{/* Render exports section */}}
      {{- with .exports -}}
        <h2 id="exports" class="" slot="">
          <a class="anchor" href="#exports">
            {{ partial "cem/octicon-link.html" $ }}
          </a>Exports
        </h2>
        {{- range . -}}
          <p><code>{{ .kind }} {{ .name }}</code>{{ with .declaration }}{{ if .module }} from <code>{{ .module }}</code>{{ end }}{{ end }}</p>
        {{- end -}}
      {{- end -}}
    {{- end -}}

  {{- else -}}
    <div class="api-error">
      <p>⚠️ No API manifest found for package: <code>{{ $pkg }}</code></p>
    </div>
  {{- end -}}

{{- else -}}
  <div class="api-error">
    <p>⚠️ Missing package or module parameters in front matter. Add:</p>
    <pre>package: "packagename"
module: "path/to/module.js"</pre>
  </div>
{{- end -}}
